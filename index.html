<html>
        <head>
                <meta charset="utf-8">
            <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
            <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
            <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
                <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
                <script src="https://raw.github.com/jasondavies/d3-cloud/master/d3.layout.cloud.js"></script>
			    <script src="parser_normal.js"></script>         
        	    <script src="parser_irssi.js"></script>        	  
				<script src="word-cloud.js"></script>
			    <script>
        		var parsers = [];
         		parsers["normal"] = parser_normal;
         		parsers["irssi"] = new Parser_irssi();
        		the_parser = parsers["irssi"]
        		var logs = [];

                /* var format = /^# (\d+)\:(\d+) (<.+?>) (.+?)$/;
                
                var users = {}; */

                
                function getLogs(source, max) {
        		    return the_parser.parse_logs(source,max);
        	    /*
                        var lines = source.split(/\n+/);
                        var logs = [];
                        for (var i=0, len=(max<lines.length ? max : lines.length); i<len; i++) {
                                var match = format.exec(lines[i]);
                                if (match) {
                                        logs.push({time: new Date(0,0,0,match[1],match[2]), user: match[3].substring(1,match[3].length-1), text: match[4]})
                                }
                        }
                        return logs; */
                }
                
                function getLogsTable(logs) {
                        var html = '<table><thead><tr><td>Time</td><td>User</td><td>Text</td></tr></thead><tbody>';
                        var hasSelectedUsers = $('#users .ui-selected').length>0;
                        var timeValue = $("#time").val();
                        var timeMatch = /^\s*(\d+)\:(\d+)\s*-\s*(\d+)\:(\d+)\s*$/.exec(timeValue);
                        if (timeMatch) {
                                timeStart = new Date(0,0,0,timeMatch[1],timeMatch[2]);
                                timeEnd = new Date(0,0,0,timeMatch[3],timeMatch[4]);
                        }
						var tmpUsers = {};
						var tmpWords = {};
						var simpleWordsRegex = /\W+/
                        for (var i=0;i<logs.length;i++) {
							// we will build the word cloud with all users mentioned for selected time
							if (timeMatch && (logs[i].time < timeStart || logs[i].time > timeEnd)) {continue;}
							if (!tmpUsers[logs[i].user]) {tmpUsers[logs[i].user]=0}
							tmpUsers[logs[i].user]++
							var tokens = logs[i].text.toLowerCase().split(simpleWordsRegex);
							for (var j=0, len=tokens.length; j<len; j++) {
								if (stopwords[tokens[j]]) {continue} // skip over stopwords
								if (!tmpWords[tokens[j]]) {tmpWords[tokens[j]]=0}
								tmpWords[tokens[j]]++;
							}
                            if (hasSelectedUsers && !users[logs[i].user]) {continue;} // skip for filtered users
                            html+='<tr><td>'+logs[i].time.getHours()+':'+(logs[i].time.getMinutes()<10 ? '0' : '')+logs[i].time.getMinutes()+'</td><td>'+logs[i].user+'</td><td>'+logs[i].text+"</td></tr>";
                        }
						
						// show word cloud for users
						var data = [];
						for (user in tmpUsers) {
							data.push({text: user, size: tmpUsers[user]})
						}
						drawWordCloud("#users_cloud", data);

						// show word cloud for words
						console.warn(tmpWords)
						var data = [];
						for (word in tmpWords) {
							data.push({text: word, size: tmpWords[word]})
						}
						drawWordCloud("#words_cloud", data);
						
                        html+='</tbody></table>';
                        return html;

                }
                          
                // Function to get Logs table to display time, etc. To be as a test
    			function getLogsTableNormal(logs) {
    				var html = '<table><thead><tr><td>Hour</td><td>Minute</td><td>User</td><td>Text</td></tr></thead><tbody>';
    				for (var i=0;i<logs.length;i++) 
    					if (logs[i].type == "message")
    						html+='<tr><td>'+logs[i].time.getHours()+'</td><td>'+logs[i].time.getMinutes()+'</td><td>'+logs[i].user+'</td><td>'+logs[i].text+"</td></tr>";
    					html+='</tbody></table>';
    					return html;

               }                
                
        		function displayLogsNormal() {
                    var source = $('#source').val();
                    var logs = getLogs(source, 100);
		   		    $('#preview').html(getLogsTableNormal(logs));
				}		
        		
                            
	            var stopwords = {}
                $(document).ready(function() {
					// load default logs data
		            $.ajax({ 
		                type: "GET", 
		                url: "logs/drupal-support.log",//get response from this file
		                success: function(response){ 
 
		                 $("#source").val(response);//send response to textarea
		  			}
		  	    });

				// load default logs data
				$.ajax({ 
	                type: "GET", 
	                url: "logs/stopwords.txt",//get response from this file
	                success: function(response){ 
						var tokens = response.split(/\n+/);
						for (var i=0, len=tokens.length; i<len; i++) {
							stopwords[tokens[i]]=true;
							if (tokens[i].indexOf("'")>0) { // apostrophes
								var parts = tokens[i].split("'");
								for (var j=0, lenj=parts.length; j<lenj; j++) {
									stopwords[parts[j]]=true;
								}
							}
						}
	  			}
	  	    });

                        $('#source').keyup(function() {
                                var source = $('#source').val();
                                var logs = getLogs(source, 5);
                                $('#preview').html(getLogsTable(logs));
                        });
						$('#source-button').hide();
                });
                function loadLogs() {
                        var source = $('#source').val();
                        logs = getLogs(source, Number.MAX_VALUE);
                        var users = {};
                        for (var i=0;i<logs.length;i++) {
                                if (users[logs[i].user]) {users[logs[i].user]++;}
                                else {users[logs[i].user]=1}
                        }

                        // first sort
                        var tmpUsers = [];
                        for (user in users) {
                                tmpUsers.push({text: user, size: users[user], freq: users[user]});
                        }
                        tmpUsers.sort(function(a,b) {return a.text.toLowerCase() > b.text.toLowerCase()});

                        // now build list
                        var html='';
                        for (var i=0;i<tmpUsers.length;i++) {
                                var user = tmpUsers[i].text;
                                html+="<li class='ui-widget-content' id='user_"+user+"'><span class='name'>"+user+'</span> ('+users[user]+")</li>";
                        }

                        $('#users').html(html);
                        $('#source-button').show();
                        $('#loading').hide();
                        updateLogs();
                }



		   function updateLogs() {
                        $("#logs").html(getLogsTable(logs));
           }
		   
            $(function() {
              $( "#users" ).selectable({
                stop: function() {
                                users = {};
                  $( ".ui-selected", this ).each(function() {
                                  users[$('.name', this).text()]=true;
                  });
                          updateLogs();
                }
              });
                  $("#time").keyup(function() {
                          updateLogs();
                  })
            });
                </script>
                <style>
            .selectable .ui-selecting { background: #FECA40; }
            .selectable .ui-selected { background: #F39814; color: white; }
            .selectable { list-style-type: none; margin: 0; padding: 0; }
                #controls {float: left;}
                #users {font-size: smaller;}
                #time {width: 7em;}
            /*.selectable li { margin: 3px; padding: 0.4em; }*/
			#source-button {text-align: right;}
			#viz {float: right;}
                </style>
        </head>
<body>
        <div id="load">
			<div id="source-button"><input type="button" value="Source" onclick="$('#loading').show(); $('#source-button').hide()"/></div>
        <div id="loading">
                <div>Paste in logs and specify format:
                        <input type="button" value="display user time" onclick="loadLogs()">
                        <input type="button" value="display logs normal" onclick="displayLogsNormal()">
                </div>
                <textarea style="width: 100%; height: 20em;" id="source"># 00:00 <w00tner> hello
11:47 -!- Sargath [~Sargath@89-73-152-177.dynamic.chello.pl] has joined #drupal-support
11:48 -!- TwstdElf [~TwstdElf@rrcs-76-79-242-50.west.biz.rr.com] has joined #drupal-support
11:48 < flezen> billyroebuck: yes i need a context. filter to show all subpages
11:49 < flezen> i got it working now, with a php-snippet, filtering for plid, parent-link-id, but then i donÂ´t get any results for this one parent page, obviously ;)
11:49 -!- HAPPYFUNBALL [~FUNKMASTA@c-174-63-120-5.hsd1.ma.comcast.net] has quit [Quit: ( www.nnscript.com :: NoNameScript 4.22 :: www.esnation.com )]
11:49 -!- boze [~boze@unaffiliated/boze] has joined #drupal-support
11:49 -!- ryanclemens [~Ryan@149-169-233-167.nat.asu.edu] has quit [Quit: ryanclemens]
11:50 -!- tanarurkerem [~pp@91-137-131-213.opticon.hu] has quit [Ping timeout: 272 seconds]
11:50 -!- ryanclemens [~Ryan@149-169-233-167.nat.asu.edu] has joined #drupal-support
11:50 -!- illmatix [~test@184.71.62.238] has joined #drupal-support
11:50 < flezen> i need to show a view of links/images of subpages, using slideshow, to use as a navigation, but as mentioned, i need them on this parent-page _and_ on all subpages ...
11:50 -!- aburrows [~aburrows@host81-139-68-141.in-addr.btopenworld.com] has joined #drupal-support
11:51 -!- emjayess [~emjayess@65.183.254.222] has joined #drupal-support
11:51 -!- emjayess [~emjayess@65.183.254.222] has quit [Changing host]
11:51 -!- emjayess [~emjayess@couchdb/user/emjayess] has joined #drupal-support
11:52 -!- ddrhythm [~dd_rhythm@173-8-213-38-Oregon.hfc.comcastbusiness.net] has joined #drupal-support
11:53 -!- spuky [~spuky@HSI-KBW-37-49-91-164.hsi14.kabel-badenwuerttemberg.de] has quit [Ping timeout: 272 seconds]
11:53 -!- dob_ [~dob@2002:5fd0:e73d:0:cdef:c594:e9af:df2c] has quit [Remote host closed the connection]
11:53 -!- pearlbear [~pearlbear@198.45.153.34] has joined #drupal-support
11:55 -!- spuky [~spuky@HSI-KBW-37-49-91-164.hsi14.kabel-badenwuerttemberg.de] has joined #drupal-support
11:55 -!- oadaeh [~jason@wsip-24-234-160-51.lv.lv.cox.net] has quit [Quit: Quitting]
11:55 -!- jerbob92-away is now known as jerbob92
11:55 -!- webflo1 [~Adium@gateway.digi-info.de] has joined #drupal-support
11:55 -!- BootcampChris [~chatzilla@host81-149-81-68.in-addr.btopenworld.com] has joined #drupal-support
11:56 < flezen> what i got is this:
</textarea>
                <div id="preview"></div>
        </div>
        <div id="panel">
			<div id="viz">
                <div id="users_cloud"></div>
                <div id="words_cloud"></div>
			</div>
                <div id="controls">
                        <div>Time: <input id="time" value="0:00-23:59"></div>
                        <ol id="users" class="selectable"></ol>
                </div>
                <div id="logs"></div>
        </div>
</body>
</html>
